services:
  mcp-bridge:
    image: mcp-bridge
    build:
      context: ../docker-files/mcp
      dockerfile: Dockerfile
    volumes:
      - ../.kilocode:/app/.kilocode:ro
    environment:
      - MCP_CONFIG_PATH=/app/.kilocode/mcp.json
    ports:
      - "3000:3000"
    network_mode: host
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  agentics:
    image: agentics
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    build:
      context: ../agents/agentics
      dockerfile: Dockerfile
      args:
        HOST_UID: ${HOST_UID}
        HOST_GID: ${HOST_GID}
    volumes:
      - ../agents/agentics/src:/app/prod
      - ..:/project
    environment:
      - PROJECT_ROOT=/project
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - OLLAMA_HOST=http://localhost:11434
      - OLLAMA_REASONING_MODEL=${OLLAMA_REASONING_MODEL:-qwen2.5:14b}
      - OLLAMA_CODE_MODEL=${OLLAMA_CODE_MODEL:-qwen2.5-coder:14b}
      - TEST_ISSUE_URL=https://github.com/andyholst/obsidian-timestamp-utility/issues/20
      - PYTHONDONTWRITEBYTECODE=1
    network_mode: host
    command: python -m prod.agentics https://github.com/andyholst/obsidian-timestamp-utility/issues/20

  validate-test-suite:
    image: agentics
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    volumes:
      - ../agents/agentics/src:/app/prod
      - ..:/project
    environment:
      - PROJECT_ROOT=/project
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - OLLAMA_HOST=http://localhost:11434
      - OLLAMA_REASONING_MODEL=${OLLAMA_REASONING_MODEL:-qwen2.5:14b}
      - OLLAMA_CODE_MODEL=${OLLAMA_CODE_MODEL:-qwen2.5-coder:14b}
      - TEST_ISSUE_URL=https://github.com/andyholst/obsidian-timestamp-utility/issues/20
      - PYTHONDONTWRITEBYTECODE=1
    network_mode: host
    command: ["python", "/project/scripts/test_suite_validation.py"]

  unit-test-agents:
    image: agentics
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    volumes:
      - ../agents/agentics/src:/app/src
      - ../agents/agentics/tests:/app/tests
      - ..:/project
    environment:
      - PROJECT_ROOT=/project
      - GITHUB_TOKEN=dummy
      - OLLAMA_HOST=http://localhost:11434
      - OLLAMA_REASONING_MODEL=${OLLAMA_REASONING_MODEL:-qwen2.5:14b}
      - OLLAMA_CODE_MODEL=${OLLAMA_CODE_MODEL:-qwen2.5-coder:14b}
      - TEST_ISSUE_URL=https://github.com/andyholst/obsidian-timestamp-utility
      - PYTHONPATH=/app
      - TEST_FILTER=${TEST_FILTER}
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
      - PYTHONDONTWRITEBYTECODE=1
      - MCP_SERVER_URL=http://localhost:3000
    command: ["bash", "-c", "cd /app && python -m pytest tests/unit/ -vv -s --tb=long $${TEST_FILTER}"]
    network_mode: host

  integration-test-agents:
    image: agentics
    user: root
    volumes:
      - ../agents/agentics/src:/app/src
      - ../agents/agentics/tests:/app/tests
      - ..:/app
      - ../logs:/app/logs
      - ../agents/agentics/.cache/huggingface:/tmp/.cache/huggingface
    environment:
      - PROJECT_ROOT=/app
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - OLLAMA_HOST=http://localhost:11434
      - OLLAMA_REASONING_MODEL=${OLLAMA_REASONING_MODEL:-qwen2.5:14b}
      - OLLAMA_CODE_MODEL=${OLLAMA_CODE_MODEL:-qwen2.5-coder:14b}
      - TEST_ISSUE_URL=${TEST_ISSUE_URL:-https://github.com/andyholst/obsidian-timestamp-utility}
      - PYTHONPATH=/app
      - TEST_FILTER=${TEST_FILTER}
      - OLLAMA_TIMEOUT=${OLLAMA_TIMEOUT:-300}
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
      - PYTHONDONTWRITEBYTECODE=1
      - MCP_SERVER_URL=http://localhost:3000
    command: ["bash", "-c", "cd /app && python -m pytest tests/integration/ -vv -s --tb=long $${TEST_FILTER}"]
    network_mode: host

  unit-test-agents-verbose:
    image: agentics
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    volumes:
      - ../agents/agentics/src:/app/src
      - ../agents/agentics/tests:/app/tests
      - ..:/project
      - ../logs:/app/logs
      - ../agents/agentics/.cache/huggingface:/tmp/.cache/huggingface
    environment:
      - PROJECT_ROOT=/project
      - GITHUB_TOKEN=dummy
      - OLLAMA_HOST=http://localhost:11434
      - OLLAMA_REASONING_MODEL=${OLLAMA_REASONING_MODEL:-qwen2.5:14b}
      - OLLAMA_CODE_MODEL=${OLLAMA_CODE_MODEL:-qwen2.5-coder:14b}
      - TEST_ISSUE_URL=https://github.com/andyholst/obsidian-timestamp-utility
      - PYTHONPATH=/app
      - TEST_FILTER=${TEST_FILTER}
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
      - PYTHONDONTWRITEBYTECODE=1
      - MCP_SERVER_URL=http://localhost:3000
    command:
      - bash
      - -c
      - |
        failed=0; total_collected=$$; echo "=== Collected $$total_collected tests before running all ===" ; for file in tests/unit/test_*.py; do base_file="$${file##*/}"; base_file="$${base_file%.py}"; tests="$$(python -m pytest --collect-only -q "$$file" | grep '::' | sed 's/.*:://')"; if [ -z "$$tests" ]; then echo "‚ö†Ô∏è No tests found in $$file"; python -m pytest --collect-only -q "$$file"; continue; fi; echo "üß™ Found tests: $$tests"; for test in $$tests; do echo "‚ñ∂Ô∏è Running: $$test"; timestamp=$$(date -u +%Y-%m-%d_%H%M%S); logfile="/app/logs/$${timestamp}_$${base_file}_$${test}_output.txt"; python -m pytest -vv -s --tb=long "$$file" -k "$$test" $${TEST_FILTER} 2>&1 | tee "$$logfile"; exitcode=$${PIPESTATUS[0]}; if [ $$exitcode -ne 0 ]; then echo "‚ùå FAILED: $$test"; cat "$$logfile"; mv "$$logfile" "/app/logs/failed/"; failed=1; else echo "‚úÖ PASSED: $$test"; mv "$$logfile" "/app/logs/success/"; fi; done; done; echo "=== Ran $$total_collected tests (all attempted individually) ===" ; echo 'üèÅ Unit tests completed.'; exit $$failed
    network_mode: host

  unit-test-agents-watch:
    image: agentics
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    volumes:
      - ../agents/agentics/src:/app/src
      - ../agents/agentics/tests:/app/tests
      - ..:/project
      - ../logs:/app/logs
    environment:
      - PROJECT_ROOT=/project
      - GITHUB_TOKEN=dummy
      - OLLAMA_HOST=http://localhost:11434
      - OLLAMA_REASONING_MODEL=${OLLAMA_REASONING_MODEL:-qwen2.5:14b}
      - OLLAMA_CODE_MODEL=${OLLAMA_CODE_MODEL:-qwen2.5-coder:14b}
      - TEST_ISSUE_URL=https://github.com/andyholst/obsidian-timestamp-utility
      - PYTHONPATH=/app
      - TEST_FILTER=${TEST_FILTER}
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
      - PYTHONDONTWRITEBYTECODE=1
      - MCP_SERVER_URL=http://localhost:3000
    command:
      - watchmedo
      - auto-restart
      - --patterns=*.py
      - --recursive
      - /app/src
      - /app/tests/unit
      - --
      - bash
      - -c
      - |
        failed=0; total_collected=$$; echo "=== Collected $$total_collected tests before running all ===" ; for file in tests/unit/test_*.py; do base_file="$${file##*/}"; base_file="$${base_file%.py}"; tests="$$(python -m pytest --collect-only -q "$$file" | grep '::' | sed 's/.*:://')"; if [ -z "$$tests" ]; then echo "‚ö†Ô∏è No tests found in $$file"; python -m pytest --collect-only -q "$$file"; continue; fi; echo "üß™ Found tests: $$tests"; for test in $$tests; do echo "‚ñ∂Ô∏è Running: $$test"; timestamp=$$(date -u +%Y-%m-%d_%H%M%S); logfile="/app/logs/$${timestamp}_$${base_file}_$${test}_output.txt"; python -m pytest -vv -s --tb=long "$$file" -k "$$test" $${TEST_FILTER} 2>&1 | tee "$$logfile"; exitcode=$${PIPESTATUS[0]}; if [ $$exitcode -ne 0 ]; then echo "‚ùå FAILED: $$test"; cat "$$logfile"; mv "$$logfile" "/app/logs/failed/"; failed=1; else echo "‚úÖ PASSED: $$test"; mv "$$logfile" "/app/logs/success/"; fi; done; done; echo "=== Ran $$total_collected tests (all attempted individually) ===" ; echo 'üèÅ Unit tests completed.'; exit $failed
    network_mode: host
    restart: unless-stopped

  integration-test-agents-verbose:
    image: agentics
    user: root
    volumes:
      - ../agents/agentics/src:/app/src
      - ../agents/agentics/tests:/app/tests
      - ..:/project
      - ../logs:/app/logs
      - ../agents/agentics/.cache/huggingface:/tmp/.cache/huggingface
    environment:
      - PROJECT_ROOT=/project
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - OLLAMA_HOST=http://localhost:11434
      - OLLAMA_REASONING_MODEL=${OLLAMA_REASONING_MODEL:-qwen2.5:14b}
      - OLLAMA_CODE_MODEL=${OLLAMA_CODE_MODEL:-qwen2.5-coder:14b}
      - TEST_ISSUE_URL=${TEST_ISSUE_URL:-https://github.com/andyholst/obsidian-timestamp-utility}
      - PYTHONPATH=/app
      - TEST_FILTER=${TEST_FILTER}
      - OLLAMA_TIMEOUT=${OLLAMA_TIMEOUT:-300}
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
      - PYTHONDONTWRITEBYTECODE=1
      - MCP_SERVER_URL=http://localhost:3000
    command:
      - bash
      - -c
      - |
        failed=0; total_collected=$$; echo "=== Collected $$total_collected tests before running all ===" ; for file in tests/integration/test_*.py; do base_file="$${file##*/}"; base_file="$${base_file%.py}"; tests="$$(python -m pytest --collect-only -q "$$file" | grep '::' | sed 's/.*:://')"; if [ -z "$$tests" ]; then echo "‚ö†Ô∏è No tests found in $$file"; python -m pytest --collect-only -q "$$file"; continue; fi; echo "üß™ Found tests: $$tests"; for test in $$tests; do echo "‚ñ∂Ô∏è Running: $$test"; timestamp=$$(date -u +%Y-%m-%d_%H%M%S); logfile="/app/logs/$${timestamp}_$${base_file}_$${test}_output.txt"; python -m pytest -vv -s --tb=long "$$file" -k "$$test" $${TEST_FILTER} 2>&1 | tee "$$logfile"; exitcode=$${PIPESTATUS[0]}; if [ $$exitcode -ne 0 ]; then echo "‚ùå FAILED: $$test"; cat "$$logfile"; mv "$$logfile" "/app/logs/failed/"; failed=1; else echo "‚úÖ PASSED: $$test"; mv "$$logfile" "/app/logs/success/"; fi; done; done; echo "=== Ran $$total_collected tests (all attempted individually) ===" ; echo 'üèÅ Integration tests completed.'; exit $$failed
    network_mode: host

  integration-test-agents-watch:
    image: agentics
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    volumes:
      - ../agents/agentics/src:/app/src
      - ../agents/agentics/tests:/app/tests
      - ..:/project
      - ../logs:/app/logs
    environment:
      - PROJECT_ROOT=/project
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - OLLAMA_HOST=http://localhost:11434
      - OLLAMA_REASONING_MODEL=${OLLAMA_REASONING_MODEL:-qwen2.5:14b}
      - OLLAMA_CODE_MODEL=${OLLAMA_CODE_MODEL:-qwen2.5-coder:14b}
      - TEST_ISSUE_URL=${TEST_ISSUE_URL:-https://github.com/andyholst/obsidian-timestamp-utility}
      - PYTHONPATH=/app
      - TEST_FILTER=${TEST_FILTER}
      - OLLAMA_TIMEOUT=${OLLAMA_TIMEOUT:-300}
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
      - PYTHONDONTWRITEBYTECODE=1
    command:
      - watchmedo
      - auto-restart
      - --patterns=*.py
      - --recursive
      - /app/src
      - /app/tests/integration
      - --
      - bash
      - -c
      - |
        failed=0; total_collected=$$; echo "=== Collected $$total_collected tests before running all ===" ; for file in tests/integration/test_*.py; do base_file="$${file##*/}"; base_file="$${base_file%.py}"; tests="$$(python -m pytest --collect-only -q "$$file" | grep '::' | sed 's/.*:://')"; if [ -z "$$tests" ]; then echo "‚ö†Ô∏è No tests found in $$file"; python -m pytest --collect-only -q "$$file"; continue; fi; echo "üß™ Found tests: $$tests"; for test in $$tests; do echo "‚ñ∂Ô∏è Running: $$test"; timestamp=$$(date -u +%Y-%m-%d_%H%M%S); logfile="/app/logs/$${timestamp}_$${base_file}_$${test}_output.txt"; python -m pytest -vv -s --tb=long "$$file" -k "$$test" $${TEST_FILTER} 2>&1 | tee "$$logfile"; exitcode=$${PIPESTATUS[0]}; if [ $$exitcode -ne 0 ]; then echo "‚ùå FAILED: $$test"; cat "$$logfile"; mv "$$logfile" "/app/logs/failed/"; failed=1; else echo "‚úÖ PASSED: $$test"; mv "$$logfile" "/app/logs/success/"; fi; done; done; echo "=== Ran $$total_collected tests (all attempted individually) ===" ; echo 'üèÅ Integration tests completed.'; exit $$failed
    network_mode: host
    restart: unless-stopped
